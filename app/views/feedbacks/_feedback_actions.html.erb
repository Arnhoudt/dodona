<% content_for :javascripts do %>
  <%= javascript_pack_tag 'evaluation' %>
<% end %>

<% feedback_pointers = @feedback.siblings %>
<div class="card-supporting-text">
  <div class="routing-actions">
    <div class="page-subtitle">
      <h4><%= t('.category.user') %></h4>
      <div class="flex-spacer"></div>
      <% metadata = @feedback.evaluation_user.metadata %>
      <span class="feedback-actions-progress" data-html="true" data-toggle="tooltip" title="<%= t('evaluations.show.progress.finished', feedback_count: metadata[:done]) %> <%= t('evaluations.show.progress.unfinished', feedback_count: (metadata[:total] - metadata[:done])) %>">
        <svg class="progress-chart" viewBox="0 0 1 1" style="height: 8px; width: 100%" preserveAspectRatio="none">
          <line x1="0" y1="0.5" x2="<%= metadata[:done].to_f / metadata[:total] %>" y2="0.5" class="info"></line>
          <line x1="<%= metadata[:done].to_f / metadata[:total] %>" y1="0.5" x2="1" y2="0.5" class="not-started"></line>
        </svg>
      </span>
    </div>
    <%= feedback_action_button t('.direction.prev'), feedback_pointers[:user][:prev] %>
    <%= feedback_action_button t('.direction.random'), feedback_pointers[:user][:random] %>
    <%= feedback_action_button t('.direction.next'), feedback_pointers[:user][:next] %>

    <div class="page-subtitle">
      <h4><%= t('.category.exercise') %></h4>
      <div class="flex-spacer"></div>
      <% metadata = @feedback.evaluation_exercise.metadata %>
      <span class="feedback-actions-progress" data-html="true" data-toggle="tooltip" title="<%= t('evaluations.show.progress.finished', feedback_count: metadata[:done]) %> <%= t('evaluations.show.progress.unfinished', feedback_count: (metadata[:total] - metadata[:done])) %>">
        <svg class="progress-chart" viewBox="0 0 1 1" style="height: 8px; width: 100%" preserveAspectRatio="none">
          <line x1="0" y1="0.5" x2="<%= metadata[:done].to_f / metadata[:total] %>" y2="0.5" class="info"></line>
          <line x1="<%= metadata[:done].to_f / metadata[:total] %>" y1="0.5" x2="1" y2="0.5" class="not-started"></line>
        </svg>
      </span>
    </div>
    <%= feedback_action_button t('.direction.prev'), feedback_pointers[:exercise][:prev] %>
    <%= feedback_action_button t('.direction.random'), feedback_pointers[:exercise][:random] %>
    <%= feedback_action_button t('.direction.next'), feedback_pointers[:exercise][:next] %>
  </div>
</div>

<div class="card-supporting-text card-border">
  <%= form_for @feedback, remote: true do |f| %>
    <center>
      <div class="form-group">
        <% state = !@feedback.completed ? "completed": "unfinished" %>
        <%= f.submit t(".completed.button.#{state}"), class: "btn btn-primary btn-text" %>
      </div>
    </center>
    <%= f.hidden_field :completed, value: !@feedback.completed %>
    <div class="form-group">
      <input id="auto-mark" type="checkbox" name="auto_mark" <%= "checked" if @auto_mark %>>
      <label class="checkbox-label" for="auto-mark"><%= t('.automatically_mark') %></label>
      <span class="help-block"><%= t(".auto-mark-help") %></span>
    </div>
  <% end %>
</div>
<script>
  $(() => window.dodona.interceptNavClicks("<%= feedback_url(@feedback, feedback: { completed: true }) %>"))
</script>
