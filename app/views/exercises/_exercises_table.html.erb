<% get_exercise_path ||= method(:exercise_path) %>
<% if defined? user
     user = user || current_user
   else
     user = current_user
   end %>

<div class="table-scroll-wrapper">
  <table class="table exercise-table table-resource">
    <thead>
    <tr>
      <th class='status-icon'></th>
      <th><%= t "exercises.index.exercise" %></th>
      <% if @course.blank? || local_assigns[:series]&.progress_enabled || current_user&.course_admin?(@course) %>
        <th class='count hidden-xs'>
          <% if @course %>
            <%= t "exercises.index.class_progress" %>
            <% unless series.progress_enabled %>
              <i class="mdi mdi-eye-off mdi-12 progress_visibility"
               data-toggle="tooltip"
               data-placement="top"
               title="<%= t('exercises.index.class_progress_visibility_disabled') %>"
              >
              </i>
            <% end %>
          <% end %>
        </th>
      <% end %>
      <% if user_signed_in? %>
        <th class='status ellipsis-overflow' title="<%= t "exercises.index.status" %>"><%= t "exercises.index.status" %></th>
        <th class='status-icon'></th>
      <% end %>
    </tr>
    </thead>
    <tbody>
    <% local_assigns[:exercises].each do |exercise| %>
      <tr>
        <td class='status-icon'>
          <% if user_signed_in? %>
            <% if current_user.repository_admin?(exercise.repository) || current_user.course_admin?(@course) %>
              <%= render partial: 'exercises/repository_status', locals: {exercise: exercise, series: local_assigns[:series]} %>
            <% end %>
            <%= render partial: 'exercises/user_status_icon', locals: {exercise: exercise, series: local_assigns[:series], user: user} %>
          <% end %>
        </td>

        <td>
          <% if exercise.accessible?(current_user, @course) %>
            <%= link_to exercise.name, get_exercise_path.call(exercise) %>
          <% elsif exercise.access_public? %>
            <%= link_to exercise.name, exercise_path(exercise) %>
          <% else %>
            <%= exercise.name %>
          <% end %>
        </td>

        <% if @course.blank? || local_assigns[:series]&.progress_enabled || current_user&.course_admin?(@course) %>
          <td class="hidden-xs">
            <% if @course %>
              <%= render partial: 'application/progress_chart',
                locals: {
                  total: @course.subscribed_members_count,
                  tried: exercise.users_tried(@course),
                  correct: exercise.users_correct(@course),
                  info_tried: 'exercises.index.progress_chart_info_tried',
                  info_correct: 'exercises.index.progress_chart_info_correct'
                }
              %>
            <% else %>
              <%= content_tag :span, title: t('exercises.exercise.count_tooltip'), class: "text-right text-muted" do %>
                <%= exercise.users_correct %>/<%= exercise.users_tried %>
              <% end %>
            <% end %>
          </td>
        <% end %>

        <% if user_signed_in? %>
          <td>
            <%= render partial: 'exercises/user_status', locals: {exercise: exercise, series: series, user: user} %>
          </td>
          <td>
            <% if exercise.started_for?(user, local_assigns[:series]) || current_user.course_admin?(local_assigns[:series]&.course) %>
              <% options = current_user == user ? {} : {user_id: user.id} %>
              <%= link_to submissions_scoped_path(exercise: exercise, course: series&.course, series: series, options: options),
                          title: t('layout.menu.my_submissions'),
                          class: 'btn-icon' do %>
                <i class="mdi mdi-chevron-right mdi-18"></i>
              <% end %>
            <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>
<center><%= page_navigation_links exercises, true, "exercises" if exercises.try(:total_pages) %></center>
